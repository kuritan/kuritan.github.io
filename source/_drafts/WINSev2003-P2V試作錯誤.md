---
title: WINSev2003 P2V試作錯誤
date: 2018-05-20 12:14:24
categories: infra
tags: 
 - Hyper-V
 - JP
---
# 背景
数多く存在している古いバージョンのWindowsServer物理機の保守期限が迫られ、継続的に運用することを考慮し、バーチャル化を検討している。
<!--more-->

# 試行錯誤
## 結論
P2V成功し、仮想マシンは安定している。
> - 対象物理機にて、「Disk2vhd」を利用し全ドライブを一つのVHDXファイルに転換
> - 作業は主に[こちら](https://yamanxworld.blogspot.jp/2011/08/v2v-error-loading-operating-system.html)を参考
> - 本番ホストにて、対象物理機の仮想マシンを作り上げ、VHDXファイルの拡張を実施
> - 本番ホストのドライブ文字の無駄消費を回避するため、もう一つの仮想マシン(win10)を立ち上げ、拡張したVHDXファイルをwin10仮想マシンにコピーし、領域操作を行い、最後に本番ホストへ移す。
> - メモリ＆ プロセッサを調整してから、仮想マシンを起動
> - 黒画面のままで、なんとかローカルadministratorでログイン成功

## 以下は細かい経緯
- テスト環境で色々試したところ、まず対象物理機のCドライブだけP2Vし、下記のように実施した。
> トライ＆エラーで[こちら](https://yamanxworld.blogspot.jp/2011/08/v2v-error-loading-operating-system.html)を参考し、無事できた。

- 対象物理機全ドライブをVHDXにし(P2V)、再トライ（必ずstand-alone状態）
 - 本番物理サーバで直接領域操作（vhdxファイルを物理機にマウントする必要がある）をすると、物理機のドライブ文字を複数占用することになり、物理機が再起動するまで、解放することがないというデメリットを生じます。その影響を考慮し、もう一つwin10のVMを立ち上げ、対象物理機のvhdxファイルに関する操作は、全部そちらで行った。
 - 無事立ち上げ成功だが、ログオン画面で黒画面問題のせいで、ログインできない。（黒画面ので、エラーメッセージがわからない、対処しようがない）

 - 謎のエラーメッセージはドメインとの信頼関係が破損と考えられる、ここで対象物理機のローカルadministratorでログイン
 - VM設定で、プロセッサを1から4に上げて（物理sumireは8ですが、さすがに130では無理）から、重い感じがなくなって、無事にログイン成功
 - マウスを使えるようにするため、統合サービスを入れること
- ログイン後、タスクマネジャーから見ると、CPU使用率が異常に高いとわかりました。
 - プログラムの追加と削除で物理機関連のいらないも全部削除
 - ディバイスマネジャーで、チーミングのCOM2削除（エラー表示の方）



# 本番切り替え
- 大体の操作ステップは↓
>- 物理機シャットダウン
>- 仮想機を仮想Switchに接続
>- 仮想機起動
>- IP変更
>- 仮想機再起動
>- 動作確認

- 予想外の出来事もあった。
 - ドメインとの信頼関係が破損→ドメイン入れ直しを実施
 > 入れ直ししても、以前のユーザ権限がなくなることがないので、ご安心ください
 - 再起動は、思ったより遥かに時間かかる